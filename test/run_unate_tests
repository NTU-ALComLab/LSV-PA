#!/bin/bash
#
# Test script for lsv_unate_bdd and lsv_unate_sat commands
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ABC="$PROJECT_DIR/abc"
TEST_DIR="$SCRIPT_DIR/circuits"
SPEC_FILE="$SCRIPT_DIR/test_spec.txt"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
TOTAL_TESTS=0
PASSED_BDD=0
FAILED_BDD=0
PASSED_SAT=0
FAILED_SAT=0

# Check if ABC exists
if [ ! -x "$ABC" ]; then
    echo -e "${RED}Error: ABC binary not found at $ABC${NC}"
    echo "Please build ABC first with 'make'"
    exit 1
fi

# Generate test circuits if needed
if [ ! -f "$SPEC_FILE" ]; then
    echo "Generating test circuits..."
    python3 "$SCRIPT_DIR/gen_unate_tests.py"
fi

echo "=========================================="
echo "Testing lsv_unate_bdd and lsv_unate_sat"
echo "=========================================="
echo ""

# Function to run a single test
run_test() {
    local blif_file="$1"
    local k="$2"
    local i="$3"
    local expected="$4"
    local command="$5"  # "bdd" or "sat"
    
    local prep_cmd=""
    if [ "$command" = "bdd" ]; then
        prep_cmd="read $blif_file; strash; collapse; lsv_unate_bdd $k $i"
    else
        prep_cmd="read $blif_file; strash; lsv_unate_sat $k $i"
    fi
    
    # Run ABC and capture output
    local output
    output=$("$ABC" -c "$prep_cmd" 2>&1)
    
    # Extract the result (first non-empty line after command output)
    local result
    result=$(echo "$output" | grep -E "^(positive unate|negative unate|binate|independent)$" | head -1)
    
    # For binate, we just check that it says "binate"
    if [ "$expected" = "binate" ]; then
        if echo "$result" | grep -q "^binate"; then
            return 0
        else
            return 1
        fi
    else
        if [ "$result" = "$expected" ]; then
            return 0
        else
            return 1
        fi
    fi
}

# Read test specifications and run tests
while IFS=' ' read -r blif_file k i expected; do
    # Skip empty lines and comments
    [[ -z "$blif_file" || "$blif_file" =~ ^# ]] && continue
    
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    
    filename=$(basename "$blif_file")
    
    # Test BDD version
    if run_test "$blif_file" "$k" "$i" "$expected" "bdd"; then
        PASSED_BDD=$((PASSED_BDD + 1))
        bdd_status="${GREEN}PASS${NC}"
    else
        FAILED_BDD=$((FAILED_BDD + 1))
        bdd_status="${RED}FAIL${NC}"
    fi
    
    # Test SAT version
    if run_test "$blif_file" "$k" "$i" "$expected" "sat"; then
        PASSED_SAT=$((PASSED_SAT + 1))
        sat_status="${GREEN}PASS${NC}"
    else
        FAILED_SAT=$((FAILED_SAT + 1))
        sat_status="${RED}FAIL${NC}"
    fi
    
    printf "%-20s k=%d i=%d %-16s BDD:%-6b SAT:%-6b\n" \
           "$filename" "$k" "$i" "$expected" "$bdd_status" "$sat_status"

done < "$SPEC_FILE"

echo ""
echo "=========================================="
echo "Test Summary"
echo "=========================================="
echo "Total test cases: $TOTAL_TESTS"
echo ""
echo "BDD version:"
echo -e "  Passed: ${GREEN}$PASSED_BDD${NC}"
echo -e "  Failed: ${RED}$FAILED_BDD${NC}"
echo ""
echo "SAT version:"
echo -e "  Passed: ${GREEN}$PASSED_SAT${NC}"
echo -e "  Failed: ${RED}$FAILED_SAT${NC}"
echo ""

# Exit with error if any test failed
if [ $FAILED_BDD -gt 0 ] || [ $FAILED_SAT -gt 0 ]; then
    echo -e "${RED}Some tests FAILED${NC}"
    exit 1
else
    echo -e "${GREEN}All tests PASSED${NC}"
    exit 0
fi

